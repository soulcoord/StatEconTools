<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>工程經濟因子速查表</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #FFAC1C;
      --background-dark: #121212;
      --surface-dark: #1E1E1E;
      --text-primary: #E0E0E0;
      --hover-state: rgba(255, 172, 28, 0.15);
      --border-color: #3A3A3A;
      --accent-dark: #2A2A2A;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--background-dark);
      color: var(--text-primary);
    }

    .navbar-custom {
      background: var(--surface-dark);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.6);
      padding: 0.5rem 1rem;
    }
    .navbar-brand {
      color: var(--primary-color) !important;
      font-weight: 600;
      transition: color 0.2s ease;
    }
    .navbar-brand:hover {
      color: #fff !important;
    }

    .main-container {
      height: calc(100vh - 56px);
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }

    .header-section {
      background: var(--surface-dark);
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      flex-shrink: 0;
    }
    .input-group-dynamic {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: nowrap;
    }
    .form-control-custom, .form-select {
      background: var(--accent-dark);
      border: 1px solid var(--border-color);
      color: #FFFFFF;
      border-radius: 6px;
      padding: 0.4rem 0.75rem;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      min-width: 100px;
    }
    .form-control-custom:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(255, 172, 28, 0.25);
      background: #333;
    }
    .rate-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
      font-size: 0.9rem;
    }
    .text-muted {
      color: #A0A0A0;
      font-size: 0.75rem;
      text-align: center;
    }

    .btn-primary {
      background: var(--primary-color);
      border: none;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      transition: all 0.3s ease;
      color: #1A1A1A;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(255, 172, 28, 0.3);
    }
    .btn-primary:hover {
      background: #ffbf4d;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 172, 28, 0.4);
    }
    .btn-icon {
      padding: 0.4rem;
      width: 38px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .table-container {
      flex-grow: 1;
      border-radius: 8px;
      background: var(--surface-dark);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      margin-top: 1rem;
    }
    .table-header {
      background: var(--accent-dark);
      padding: 0.5rem 0;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    .table-header-row {
      display: flex;
      width: 100%;
    }
    .table-header-cell {
      text-align: center;
      padding: 0.5rem;
      font-weight: 600;
      color: var(--primary-color);
      font-size: 0.9rem;
    }
    .table-header-cell:first-child {
      background: var(--surface-dark);
      box-shadow: 2px 0 4px rgba(0, 0, 0, 0.2);
    }
    .table-body-wrapper {
      flex-grow: 1;
      overflow-y: auto;
      overflow-x: auto;
      max-height: calc(100vh - 250px);
    }
    .factor-table {
      width: 100%;
      border-collapse: collapse;
    }
    .factor-table td {
      padding: 0.6rem;
      text-align: center;
      border: 1px solid var(--border-color);
      font-size: 0.9rem;
      transition: background 0.2s ease;
    }
    .factor-table td:first-child {
      position: sticky;
      left: 0;
      background: var(--surface-dark);
      z-index: 5;
      font-weight: 500;
      box-shadow: 2px 0 4px rgba(0, 0, 0, 0.2);
    }
    .factor-table tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.02);
    }
    .factor-table td:hover {
      background: var(--hover-state);
      cursor: pointer;
    }
    .highlight-cell {
      background: #FFE082 !important;
      color: #212121;
      animation: highlight 1s ease-out forwards;
    }
    @keyframes highlight {
      0% { background-color: var(--primary-color); transform: scale(1.05); }
      100% { background-color: #FFE082; transform: scale(1); }
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1050;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    .loading-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    .spinner {
      width: 3rem;
      height: 3rem;
      border: 0.4em solid var(--primary-color);
      border-right-color: transparent;
      border-radius: 50%;
      animation: spin 0.75s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .calculator-modal .modal-content {
      background: var(--surface-dark);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
    }
    .calculator-modal .modal-header {
      border-bottom: 1px solid var(--border-color);
    }
    .calculator-modal .input-group {
      margin: 0.5rem 0;
      position: relative;
    }
    .calculator-modal .input-group-text {
      background: var(--accent-dark);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      min-width: 100px;
      font-size: 0.85rem;
    }
    .calculation-flow {
      margin-top: 0.75rem;
      padding: 0.5rem;
      background: var(--accent-dark);
      border-radius: 6px;
      font-size: 0.85rem;
      text-align: center;
      overflow-x: auto;
      white-space: nowrap;
      border: 1px solid var(--border-color);
    }
    .flow-step {
      display: inline-flex;
      align-items: center;
      padding: 0.4rem 0.8rem;
      background: #333;
      border-radius: 4px;
      margin: 0 0.2rem;
    }
    .flow-arrow {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      color: var(--primary-color);
      font-size: 1rem;
      margin: 0 0.2rem;
      background: rgba(255, 172, 28, 0.1);
      border-radius: 50%;
    }
    .copy-btn {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--primary-color);
      border: none;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      color: #1A1A1A;
      font-size: 0.8rem;
    }
    .copy-btn:hover {
      background: #ffbf4d;
    }

    .sidebar {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100%;
      background: var(--surface-dark);
      box-shadow: -4px 0 16px rgba(0, 0, 0, 0.4);
      z-index: 1030;
      transition: right 0.3s ease-in-out;
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }
    .sidebar.active {
      right: 0;
    }
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.75rem;
      margin-bottom: 0.75rem;
      flex-shrink: 0;
    }
    .sidebar-search {
      margin-bottom: 0.75rem;
      flex-shrink: 0;
    }
    .sidebar-content {
      flex-grow: 1;
      overflow-y: auto;
    }
    .history-item {
      background: var(--accent-dark);
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      border: 1px solid var(--border-color);
    }
    .history-item button {
      margin-top: 0.5rem;
      margin-right: 0.5rem;
      padding: 0.3rem 0.8rem;
      font-size: 0.8rem;
    }
    .history-flow {
      margin-top: 0.5rem;
      padding: 0.4rem;
      background: #333;
      border-radius: 4px;
      font-size: 0.8rem;
      text-align: center;
      overflow-x: auto;
      white-space: nowrap;
    }
    .history-total {
      padding: 0.75rem;
      background: var(--accent-dark);
      border-radius: 6px;
      font-weight: 600;
      text-align: right;
      margin-top: 1rem;
      border: 1px solid var(--border-color);
    }
    .total-flow {
      margin-top: 0.5rem;
      padding: 0.4rem;
      background: #333;
      border-radius: 4px;
      font-size: 0.8rem;
      text-align: center;
      overflow-x: auto;
      white-space: nowrap;
    }
    .pagination {
      margin-top: 0.75rem;
      justify-content: center;
      flex-shrink: 0;
    }
    .sidebar-toggle {
      background: var(--primary-color);
      border-radius: 6px;
      padding: 0.4rem 1rem;
      transition: opacity 0.3s ease, transform 0.3s ease;
      color: #1A1A1A;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(255, 172, 28, 0.3);
    }
    .sidebar-toggle:hover {
      background: #ffbf4d;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 172, 28, 0.4);
    }
    .sidebar-toggle.hidden {
      opacity: 0;
      transform: translateX(20px);
      pointer-events: none;
    }

    .toast-container {
      max-width: 90%;
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 1100;
    }
    .toast {
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      opacity: 0;
      transform: translateY(20px);
      animation: slideIn 0.3s ease forwards;
    }
    @keyframes slideIn {
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 768px) {
      .main-container {
        padding: 0.5rem;
      }
      .header-section {
        padding: 0.75rem;
      }
      .input-group-dynamic {
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .form-control-custom, .form-select {
        width: 100%;
        padding: 0.4rem 0.6rem;
        font-size: 0.85rem;
      }
      .btn-primary {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
      }
      .table-header-cell,
      .factor-table td {
        padding: 0.4rem;
        font-size: 0.85rem;
      }
      .table-body-wrapper {
        max-height: calc(100vh - 300px);
      }
      .sidebar {
        width: 100%;
        right: -100%;
      }
      .calculation-flow, .history-flow, .total-flow {
        font-size: 0.75rem;
        padding: 0.3rem;
      }
      .flow-step {
        padding: 0.3rem 0.6rem;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-custom">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrow-left me-2" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
        </svg>
        返回首頁
      </a>
    </div>
  </nav>

  <div class="main-container">
    <div class="header-section">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h1 class="h4 m-0">工程經濟因子速查表</h1>
        <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">歷史記錄</button>
      </div>
      <div class="input-group-dynamic">
        <select id="factorType" class="form-select" style="min-width: 180px;">
          <option value="F/P">終值因子 (F/P)</option>
          <option value="P/F">現值因子 (P/F)</option>
          <option value="A/P">資本回收因子 (A/P)</option>
          <option value="P/A">現值年金因子 (P/A)</option>
          <option value="F/A">終值年金因子 (F/A)</option>
          <option value="A/F">償債基金因子 (A/F)</option>
          <option value="P/G">梯度現值因子 (P/G)</option>
          <option value="A/G">梯度年金因子 (A/G)</option>
        </select>
        <input type="number" id="searchN" class="form-control form-control-custom" 
               placeholder="輸入期數 (1-60)" min="1" max="60">
        <button class="btn btn-primary btn-icon" onclick="searchFactor()" title="查詢因子">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
          </svg>
        </button>
      </div>
      <div class="rate-group mt-1">
        <span>當前利率：<span id="currentRate">0.00</span>%</span>
        <input type="number" id="interestRate" class="form-control-custom" 
               style="width: 90px;" step="0.25" placeholder="輸入利率">
      </div>
      <small class="text-muted">利率更新後自動重新計算</small>
    </div>

    <div class="table-container">
      <div class="table-header">
        <div class="table-header-row">
          <div class="table-header-cell">N</div>
          <div class="table-header-cell">F/P</div>
          <div class="table-header-cell">P/F</div>
          <div class="table-header-cell">A/P</div>
          <div class="table-header-cell">P/A</div>
          <div class="table-header-cell">F/A</div>
          <div class="table-header-cell">A/F</div>
          <div class="table-header-cell">P/G</div>
          <div class="table-header-cell">A/G</div>
        </div>
      </div>
      <div class="table-body-wrapper">
        <table class="factor-table">
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="sidebar" id="historySidebar">
    <div class="sidebar-header">
      <h5 class="m-0">計算歷史記錄</h5>
      <div>
        <button class="btn btn-sm btn-danger me-2" onclick="confirmClearHistory()">清空</button>
        <button class="btn btn-sm btn-secondary" onclick="toggleSidebar()">關閉</button>
      </div>
    </div>
    <div class="sidebar-search">
      <input type="text" id="historySearch" class="form-control form-control-custom" 
             placeholder="搜索利率、期數或因子" oninput="filterHistory()">
    </div>
    <div class="sidebar-content" id="historyList"></div>
    <nav class="pagination" id="pagination"></nav>
  </div>

  <div class="loading-overlay">
    <div class="spinner"></div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <div class="modal fade calculator-modal" id="calculatorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">快速計算器</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="關閉"></button>
        </div>
        <div class="modal-body">
          <div class="input-group">
            <span class="input-group-text">選取因子值</span>
            <input type="text" id="selectedValue" class="form-control form-control-custom" readonly>
          </div>
          <div class="input-group">
            <span class="input-group-text">期數 (N)</span>
            <select id="selectedN" class="form-select form-control-custom">
              <!-- 動態生成 -->
            </select>
          </div>
          <div class="input-group">
            <span class="input-group-text">選擇的因子</span>
            <select id="selectedFactor" class="form-select form-control-custom">
              <option value="F/P">終值因子 (F/P)</option>
              <option value="P/F">現值因子 (P/F)</option>
              <option value="A/P">資本回收因子 (A/P)</option>
              <option value="P/A">現值年金因子 (P/A)</option>
              <option value="F/A">終值年金因子 (F/A)</option>
              <option value="A/F">償債基金因子 (A/F)</option>
              <option value="P/G">梯度現值因子 (P/G)</option>
              <option value="A/G">梯度年金因子 (A/G)</option>
            </select>
          </div>
          <hr class="my-2">
          <div class="input-group">
            <span class="input-group-text">輸入金額</span>
            <input type="number" id="inputAmount" class="form-control form-control-custom" 
                   placeholder="請輸入金額" step="100">
          </div>
          <div class="input-group mt-2">
            <span class="input-group-text">計算結果</span>
            <input type="text" id="calculationResult" class="form-control form-control-custom" 
                   style="font-size: 1rem; font-weight: 600; background: var(--accent-dark);" readonly>
            <button class="copy-btn" onclick="copyResult()">複製</button>
          </div>
          <div class="input-group mt-2">
            <span class="input-group-text">複合因子</span>
            <select id="compoundFactor" class="form-select form-control-custom">
              <option value="">無</option>
              <option value="F/P">終值因子 (F/P)</option>
              <option value="P/F">現值因子 (P/F)</option>
              <option value="A/P">資本回收因子 (A/P)</option>
              <option value="P/A">現值年金因子 (P/A)</option>
              <option value="F/A">終值年金因子 (F/A)</option>
              <option value="A/F">償債基金因子 (A/F)</option>
              <option value="P/G">梯度現值因子 (P/G)</option>
              <option value="A/G">梯度年金因子 (A/G)</option>
            </select>
          </div>
          <div class="calculation-flow" id="calculationFlow"></div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
          <button type="button" class="btn btn-primary" onclick="performCalculation()">立即計算</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const loadingOverlay = document.querySelector('.loading-overlay');
    let currentHighlight = null;
    let historyRecords = [];
    let currentPage = 1;
    const recordsPerPage = 5;

    function showLoading() {
      loadingOverlay.classList.add('active');
    }
    function hideLoading() {
      loadingOverlay.classList.remove('active');
    }

    function syncTableHeaderWidth() {
      const table = document.querySelector('.factor-table');
      const headerCells = document.querySelectorAll('.table-header-cell');
      const firstRow = table.querySelector('tbody tr');
      if (!firstRow || firstRow.cells.length === 1) return;
      const cells = firstRow.querySelectorAll('td');
      headerCells.forEach((headerCell, index) => {
        const cellWidth = cells[index].offsetWidth;
        headerCell.style.width = `${cellWidth}px`;
        headerCell.style.minWidth = `${cellWidth}px`;
      });
    }

    function syncTableHeaderScroll() {
      const tableBodyWrapper = document.querySelector('.table-body-wrapper');
      const tableHeader = document.querySelector('.table-header');
      tableHeader.scrollLeft = tableBodyWrapper.scrollLeft;
    }

    function calculateFactors() {
      showLoading();
      const rateInput = document.getElementById('interestRate').value;
      const rate = parseFloat(rateInput) / 100;
      document.getElementById('currentRate').textContent = rate ? (rate * 100).toFixed(2) : '0.00';

      setTimeout(() => {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        if (!rate || rate <= 0) {
          tbody.innerHTML = '<tr><td colspan="9" class="text-center py-3">請輸入有效利率以顯示數據</td></tr>';
          hideLoading();
          return;
        }

        for (let n = 1; n <= 60; n++) {
          const F_P = Math.pow(1 + rate, n);
          const P_F = 1 / F_P;
          const A_P = (rate * F_P) / (F_P - 1);
          const P_A = 1 / A_P;
          const F_A = (F_P - 1) / rate;
          const A_F = rate / (F_P - 1);
          const P_G = ((F_A - n) / (rate * rate)) * P_F;
          const A_G = (1 / rate) - (n / (F_P - 1));

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${n}</td>
            <td>${F_P.toFixed(6)}</td>
            <td>${P_F.toFixed(6)}</td>
            <td>${A_P.toFixed(6)}</td>
            <td>${P_A.toFixed(6)}</td>
            <td>${F_A.toFixed(6)}</td>
            <td>${A_F.toFixed(6)}</td>
            <td>${P_G.toFixed(6)}</td>
            <td>${A_G.toFixed(6)}</td>
          `;
          tbody.appendChild(row);
        }

        const nSelect = document.getElementById('selectedN');
        nSelect.innerHTML = '';
        for (let i = 1; i <= 60; i++) {
          const option = document.createElement('option');
          option.value = i;
          option.textContent = i;
          nSelect.appendChild(option);
        }

        hideLoading();
        syncTableHeaderWidth();
      }, 300);
    }

    function searchFactor() {
      const factor = document.getElementById('factorType').value;
      const nValue = document.getElementById('searchN').value;
      const table = document.querySelector('.factor-table');
      
      if (!nValue || nValue < 1 || nValue > 60) {
        showToast('請輸入有效的期數 (1-60)', 'danger');
        return;
      }
      
      const rows = table.rows;
      let found = false;
      
      for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].cells;
        if (cells[0].textContent === nValue) {
          if (currentHighlight) currentHighlight.classList.remove('highlight-cell');
          const headerCells = document.querySelectorAll('.table-header-cell');
          let headerIndex = -1;
          for (let j = 0; j < headerCells.length; j++) {
            if (headerCells[j].textContent.trim() === factor) {
              headerIndex = j;
              break;
            }
          }
          if (headerIndex !== -1) {
            cells[headerIndex].classList.add('highlight-cell');
            currentHighlight = cells[headerIndex];
            table.parentElement.scrollTo({
              top: rows[i].offsetTop - 50,
              left: cells[headerIndex].offsetLeft - 50,
              behavior: 'smooth'
            });
            found = true;
            break;
          }
        }
      }
      if (!found) showToast('找不到符合條件的數據', 'danger');
    }

    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white bg-${type} border-0 mb-2`;
      toast.setAttribute('role', 'alert');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>`;
      toastContainer.appendChild(toast);
      const bsToast = new bootstrap.Toast(toast, { autohide: true, delay: 3000 });
      bsToast.show();
      toast.addEventListener('hidden.bs.toast', () => toast.remove());
    }

    function updateFactorValue() {
      const n = document.getElementById('selectedN').value;
      const factor = document.getElementById('selectedFactor').value;
      const rows = document.querySelector('.factor-table').rows;
      for (let row of rows) {
        if (row.cells[0].textContent === n) {
          const headerCells = document.querySelectorAll('.table-header-cell');
          let factorIndex = -1;
          for (let i = 0; i < headerCells.length; i++) {
            if (headerCells[i].textContent === factor) {
              factorIndex = i;
              break;
            }
          }
          if (factorIndex !== -1) {
            document.getElementById('selectedValue').value = parseFloat(row.cells[factorIndex].textContent).toFixed(6);
          }
          break;
        }
      }
    }

    function performCalculation() {
      const value = parseFloat(document.getElementById('selectedValue').value);
      const amount = parseFloat(document.getElementById('inputAmount').value);
      const factor = document.getElementById('selectedFactor').value;
      const n = document.getElementById('selectedN').value;
      const compoundFactor = document.getElementById('compoundFactor').value;
      const rate = parseFloat(document.getElementById('interestRate').value) / 100;
      const resultField = document.getElementById('calculationFlow');

      if (isNaN(value) || isNaN(amount)) {
        resultField.innerHTML = '請輸入有效數值以查看計算流程';
        showToast('請輸入有效金額和因子值', 'danger');
        return;
      }

      let result = value * amount;
      let compoundResult = null;
      let compoundValue = null;

      if (compoundFactor) {
        const rows = document.querySelector('.factor-table').rows;
        for (let row of rows) {
          if (row.cells[0].textContent === n) {
            const headerCells = document.querySelectorAll('.table-header-cell');
            let compoundIndex = -1;
            for (let i = 0; i < headerCells.length; i++) {
              if (headerCells[i].textContent === compoundFactor) {
                compoundIndex = i;
                break;
              }
            }
            if (compoundIndex !== -1) {
              compoundValue = parseFloat(row.cells[compoundIndex].textContent);
              compoundResult = result * compoundValue;
            }
            break;
          }
        }
      }

      const finalResult = compoundResult || result;
      document.getElementById('calculationResult').value = finalResult.toLocaleString('zh-Hant', { maximumFractionDigits: 4 });

      let flowHTML = `<span class="flow-step">${amount.toLocaleString('zh-Hant')}</span>`;
      flowHTML += `<span class="flow-arrow">×</span><span class="flow-step">${factor} (${value.toFixed(6)})</span>`;
      if (compoundFactor && compoundValue) {
        flowHTML += `<span class="flow-arrow">×</span><span class="flow-step">${compoundFactor} (${compoundValue.toFixed(6)})</span>`;
      }
      flowHTML += `<span class="flow-arrow">=</span><span class="flow-step">${finalResult.toLocaleString('zh-Hant', { maximumFractionDigits: 4 })}</span>`;
      resultField.innerHTML = flowHTML;

      const record = {
        rate: rate * 100,
        n,
        amount,
        factor,
        factorValue: value,
        compoundFactor: compoundFactor || '無',
        compoundValue: compoundValue,
        result: finalResult
      };
      historyRecords.unshift(record);
      currentPage = 1;
      updateHistoryList();
      showToast('計算成功！', 'success');
    }

    function copyResult() {
      const result = document.getElementById('calculationResult').value;
      navigator.clipboard.writeText(result).then(() => {
        showToast('結果已複製到剪貼板', 'success');
      });
    }

    function filterHistory() {
      const searchValue = document.getElementById('historySearch').value.toLowerCase();
      const filteredRecords = historyRecords.filter(record => 
        record.rate.toString().includes(searchValue) ||
        record.n.toString().includes(searchValue) ||
        record.factor.toLowerCase().includes(searchValue) ||
        record.compoundFactor.toLowerCase().includes(searchValue)
      );
      currentPage = 1;
      updateHistoryList(filteredRecords);
    }

    function updateHistoryList(filteredRecords = historyRecords) {
      const historyList = document.getElementById('historyList');
      const pagination = document.getElementById('pagination');
      historyList.innerHTML = '';
      pagination.innerHTML = '';

      const start = (currentPage - 1) * recordsPerPage;
      const end = start + recordsPerPage;
      const paginatedRecords = filteredRecords.slice(start, end);

      paginatedRecords.forEach((record, index) => {
        const globalIndex = start + index;
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `
          <div>利率: ${record.rate.toFixed(2)}%</div>
          <div>期數: ${record.n}</div>
          <div>金額: ${record.amount.toLocaleString('zh-Hant')}</div>
          <div>因子: ${record.factor}${record.compoundFactor !== '無' ? ` × ${record.compoundFactor}` : ''}</div>
          <div>結果: ${record.result.toLocaleString('zh-Hant', { maximumFractionDigits: 4 })}</div>
          <div class="history-flow">
            <span class="flow-step">${record.amount.toLocaleString('zh-Hant')}</span>
            <span class="flow-arrow">×</span>
            <span class="flow-step">${record.factor} (${record.factorValue.toFixed(6)})</span>
            ${record.compoundFactor !== '無' ? `<span class="flow-arrow">×</span><span class="flow-step">${record.compoundFactor} (${record.compoundValue.toFixed(6)})</span>` : ''}
            <span class="flow-arrow">=</span>
            <span class="flow-step">${record.result.toLocaleString('zh-Hant', { maximumFractionDigits: 4 })}</span>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-primary" onclick="recalculate(${globalIndex})">重算</button>
            <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete(${globalIndex})">刪除</button>
          </div>
        `;
        historyList.appendChild(item);
      });

      if (filteredRecords.length > 0) {
        const total = filteredRecords.reduce((sum, record) => sum + record.result, 0);
        const totalDiv = document.createElement('div');
        totalDiv.className = 'history-total';
        totalDiv.innerHTML = `
          總和: ${total.toLocaleString('zh-Hant', { maximumFractionDigits: 4 })}
          <div class="total-flow">
            ${filteredRecords.map(record => `<span class="flow-step">${record.result.toLocaleString('zh-Hant', { maximumFractionDigits: 4 })}</span>`).join('<span class="flow-arrow">+</span>')}
            <span class="flow-arrow">=</span>
            <span class="flow-step">${total.toLocaleString('zh-Hant', { maximumFractionDigits: 4 })}</span>
          </div>
        `;
        historyList.appendChild(totalDiv);

        const totalPages = Math.ceil(filteredRecords.length / recordsPerPage);
        if (totalPages > 1) {
          const ul = document.createElement('ul');
          ul.className = 'pagination';

          const prevLi = document.createElement('li');
          prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
          prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">&laquo;</a>`;
          ul.appendChild(prevLi);

          for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
            ul.appendChild(li);
          }

          const nextLi = document.createElement('li');
          nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
          nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">&raquo;</a>`;
          ul.appendChild(nextLi);

          pagination.appendChild(ul);
        }
      }
    }

    function changePage(page) {
      currentPage = page;
      updateHistoryList();
    }

    function recalculate(index) {
      const record = historyRecords[index];
      document.getElementById('inputAmount').value = record.amount;
      document.getElementById('interestRate').value = record.rate;
      document.getElementById('selectedN').value = record.n;
      document.getElementById('selectedFactor').value = record.factor;
      document.getElementById('compoundFactor').value = record.compoundFactor === '無' ? '' : record.compoundFactor;
      
      calculateFactors();
      setTimeout(() => {
        updateFactorValue();
        const modal = new bootstrap.Modal(document.getElementById('calculatorModal'));
        modal.show();
        performCalculation();
      }, 350);
    }

    function confirmDelete(index) {
      if (confirm('確定要刪除這條歷史記錄嗎？')) {
        deleteHistory(index);
      }
    }

    function deleteHistory(index) {
      historyRecords.splice(index, 1);
      updateHistoryList();
      showToast('歷史記錄已刪除', 'success');
    }

    function confirmClearHistory() {
      if (confirm('確定要清空所有歷史記錄嗎？此操作無法撤銷。')) {
        clearHistory();
      }
    }

    function clearHistory() {
      historyRecords = [];
      updateHistoryList();
      showToast('所有歷史記錄已清空', 'success');
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('historySidebar');
      const toggleBtn = document.getElementById('sidebarToggle');
      sidebar.classList.toggle('active');
      toggleBtn.classList.toggle('hidden');
    }

    function debounce(func, timeout = 300) {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => func.apply(this, args), timeout);
      };
    }

    document.getElementById('interestRate').addEventListener('input', debounce(calculateFactors, 300));
    document.getElementById('selectedN').addEventListener('change', updateFactorValue);
    document.getElementById('selectedFactor').addEventListener('change', updateFactorValue);

    document.querySelector('.factor-table').addEventListener('click', (e) => {
      if (e.target.tagName === 'TD' && e.target.cellIndex !== 0) {
        const modal = new bootstrap.Modal(document.getElementById('calculatorModal'));
        const row = e.target.parentElement;
        document.getElementById('selectedValue').value = parseFloat(e.target.textContent).toFixed(6);
        document.getElementById('selectedN').value = row.cells[0].textContent;
        document.getElementById('selectedFactor').value = document.querySelectorAll('.table-header-cell')[e.target.cellIndex].textContent;
        document.getElementById('calculationFlow').innerHTML = '請輸入金額並計算以查看流程';
        modal.show();
        document.getElementById('inputAmount').focus();
      }
    });

    window.addEventListener('resize', debounce(syncTableHeaderWidth, 100));
    document.querySelector('.table-body-wrapper').addEventListener('scroll', syncTableHeaderScroll);

    calculateFactors();
  </script>
</body>
</html>