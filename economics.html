<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>工程經濟因子速查表</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #FFAC1C;
      --background-dark: #121212;
      --surface-dark: #1E1E1E;
      --text-primary: #E0E0E0;
      --hover-state: rgba(255, 172, 28, 0.15);
      --border-color: #3A3A3A;
      --accent-dark: #2A2A2A;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--background-dark);
      color: var(--text-primary);
    }

    .navbar-custom {
      background: var(--surface-dark);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.6);
      padding: 0.5rem 1rem;
    }
    .navbar-brand {
      color: var(--primary-color) !important;
      font-weight: 600;
      transition: color 0.2s ease;
    }
    .navbar-brand:hover {
      color: #fff !important;
    }

    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem;
    }

    .header-section {
      background: var(--surface-dark);
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.4);
      border: 1px solid var(--border-color);
    }
    .input-group-dynamic {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .form-control-custom, .form-select {
      background: var(--accent-dark);
      border: 1px solid var(--border-color);
      color: #FFFFFF !important;
      border-radius: 6px;
      padding: 0.4rem 0.75rem;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }
    .form-control-custom:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(255, 172, 28, 0.25);
      background: #333;
    }
    .form-control-custom::placeholder {
      color: #A0A0A0;
    }
    .btn-primary {
      background: var(--primary-color);
      border: none;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      color: #1A1A1A;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(255, 172, 28, 0.3);
    }
    .btn-primary:hover {
      background: #ffbf4d;
      box-shadow: 0 4px 12px rgba(255, 172, 28, 0.4);
    }
    .btn-icon {
      padding: 0.4rem;
      width: 38px;
      height: 38px;
    }

    .table-container {
      margin-top: 1rem;
    }
    .factor-table {
      min-width: 1000px;
      border-collapse: collapse;
    }
    .factor-table thead th {
      position: sticky;
      top: 0;
      background: var(--accent-dark);
      color: var(--primary-color);
      font-weight: 600;
      padding: 0.75rem;
      text-align: center;
      z-index: 2;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }
    .factor-table tbody td {
      padding: 0.6rem;
      text-align: center;
      border: 1px solid var(--border-color);
      font-size: 0.9rem;
    }
    .factor-table tbody td:first-child {
      position: sticky;
      left: 0;
      background: var(--surface-dark);
      z-index: 1;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.2);
      font-weight: 500;
    }
    .factor-table tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.02);
    }
    .factor-table td:hover {
      background: var(--hover-state);
      cursor: pointer;
    }
    .highlight-cell {
      background: #FFE082 !important;
      color: #212121;
      animation: highlight 1s ease-out forwards;
    }
    @keyframes highlight {
      0% { background-color: var(--primary-color); transform: scale(1.05); }
      100% { background-color: #FFE082; transform: scale(1); }
    }

    .smart-scrollbar::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    .smart-scrollbar::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }
    .smart-scrollbar::-webkit-scrollbar-track {
      background: var(--accent-dark);
    }

    .sidebar {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100%;
      background: var(--surface-dark);
      box-shadow: -4px 0 16px rgba(0, 0, 0, 0.4);
      z-index: 1030;
      transition: right 0.3s ease-in-out;
      padding: 1rem;
    }
    .sidebar.active {
      right: 0;
    }
    .sidebar-toggle {
      background: var(--primary-color);
      color: #1A1A1A;
      font-weight: 600;
    }
    .sidebar-toggle:hover {
      background: #ffbf4d;
    }

    .calculation-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    @media (max-width: 768px) {
      .input-group-dynamic {
        flex-direction: column;
      }
      .form-control-custom, .form-select {
        width: 100%;
      }
      .sidebar {
        width: 100%;
        right: -100%;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-custom sticky-top">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrow-left me-2" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
        </svg>
        返回首頁
      </a>
      <button class="btn btn-primary sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-clock-history me-2" viewBox="0 0 16 16">
          <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zm2.004.45a7.003 7.003 0 0 0-.985-.299l.219-.976c.383.086.76.2 1.126.342l-.36.933zm1.37.71a7.01 7.01 0 0 0-.439-.27l.493-.87a8.025 8.025 0 0 1 .979.654l-.615.789a6.996 6.996 0 0 0-.418-.302zm1.834 1.79a6.99 6.99 0 0 0-.653-.796l.724-.69c.27.285.52.59.747.91l-.818.576zm.744 1.352a7.08 7.08 0 0 0-.214-.468l.893-.45a7.976 7.976 0 0 1 .45 1.088l-.95.313a7.023 7.023 0 0 0-.179-.483zm.53 2.507a6.991 6.991 0 0 0-.1-1.025l.985-.17c.067.386.106.778.116 1.17l-1 .025zm-.131 1.538c.033-.17.06-.339.081-.51l.993.123a7.956 7.956 0 0 1-.23 1.155l-.964-.267c.046-.165.086-.332.12-.501zm-.952 2.379c.184-.29.346-.594.486-.908l.914.405c-.16.36-.345.706-.555 1.038l-.845-.535zm-.964 1.205c.122-.122.239-.248.35-.378l.758.653a8.073 8.073 0 0 1-.401.432l-.707-.707z"/>
          <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0v1z"/>
          <path d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5z"/>
        </svg>
        歷史記錄
      </button>
    </div>
  </nav>

  <div class="main-container smart-scrollbar">
    <div class="header-section calculation-card">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 m-0 d-flex align-items-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-calculator me-2" viewBox="0 0 16 16">
            <path d="M12 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h8zM4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4z"/>
            <path d="M4 2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5v-2zm0 4a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-4zm3-9a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-4z"/>
          </svg>
          工程經濟因子速查表
        </h1>
      </div>

      <div class="input-group-dynamic">
        <div class="d-flex flex-column flex-grow-1">
          <label class="form-label text-muted small mb-1">選擇因子類型</label>
          <select id="factorType" class="form-select form-control-custom">
            <option value="F/P">終值因子 (F/P)</option>
            <option value="P/F">現值因子 (P/F)</option>
            <option value="A/P">資本回收因子 (A/P)</option>
            <option value="P/A">現值年金因子 (P/A)</option>
            <option value="F/A">終值年金因子 (F/A)</option>
            <option value="A/F">償債基金因子 (A/F)</option>
            <option value="P/G">梯度現值因子 (P/G)</option>
            <option value="A/G">梯度年金因子 (A/G)</option>
          </select>
        </div>
        
        <div class="d-flex flex-column flex-grow-1">
          <label class="form-label text-muted small mb-1">輸入查詢期數</label>
          <div class="input-group">
            <input type="number" id="searchN" class="form-control form-control-custom" 
                   placeholder="1-60" min="1" max="60">
            <button class="btn btn-primary btn-icon" onclick="searchFactor()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="d-flex flex-column flex-grow-1">
          <label class="form-label text-muted small mb-1">設定利率 (%)</label>
          <div class="input-group">
            <input type="number" id="interestRate" class="form-control form-control-custom"
                   step="0.25" placeholder="輸入利率">
            <span class="input-group-text" style="background: var(--accent-dark); color: var(--primary-color); border-color: var(--border-color); font-size: 0.9rem;">%</span>
          </div>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-responsive smart-scrollbar" style="max-height: calc(100vh - 220px)">
        <table class="factor-table table table-dark table-bordered table-hover align-middle m-0">
          <thead class="sticky-top">
            <tr>
              <th>N</th>
              <th>F/P</th>
              <th>P/F</th>
              <th>A/P</th>
              <th>P/A</th>
              <th>F/A</th>
              <th>A/F</th>
              <th>P/G</th>
              <th>A/G</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="sidebar shadow-lg" id="historySidebar">
    <div class="sidebar-header border-bottom pb-2 mb-3">
      <h5 class="m-0 d-flex align-items-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-clock-history me-2" viewBox="0 0 16 16">
          <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zm2.004.45a7.003 7.003 0 0 0-.985-.299l.219-.976c.383.086.76.2 1.126.342l-.36.933zm1.37.71a7.01 7.01 0 0 0-.439-.27l.493-.87a8.025 8.025 0 0 1 .979.654l-.615.789a6.996 6.996 0 0 0-.418-.302zm1.834 1.79a6.99 6.99 0 0 0-.653-.796l.724-.69c.27.285.52.59.747.91l-.818.576zm.744 1.352a7.08 7.08 0 0 0-.214-.468l.893-.45a7.976 7.976 0 0 1 .45 1.088l-.95.313a7.023 7.023 0 0 0-.179-.483zm.53 2.507a6.991 6.991 0 0 0-.1-1.025l.985-.17c.067.386.106.778.116 1.17l-1 .025zm-.131 1.538c.033-.17.06-.339.081-.51l.993.123a7.956 7.956 0 0 1-.23 1.155l-.964-.267c.046-.165.086-.332.12-.501zm-.952 2.379c.184-.29.346-.594.486-.908l.914.405c-.16.36-.345.706-.555 1.038l-.845-.535zm-.964 1.205c.122-.122.239-.248.35-.378l.758.653a8.073 8.073 0 0 1-.401.432l-.707-.707z"/>
          <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0v1z"/>
          <path d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5z"/>
        </svg>
        計算歷史
      </h5>
      <div>
        <button class="btn btn-sm btn-danger me-2" onclick="confirmClearHistory()">清空</button>
        <button class="btn btn-sm btn-secondary" onclick="toggleSidebar()">關閉</button>
      </div>
    </div>
    
    <div class="sidebar-search mb-3">
      <input type="text" id="historySearch" class="form-control form-control-custom" 
             placeholder="搜索利率、期數或因子" oninput="filterHistory()">
    </div>

    <div class="sidebar-content smart-scrollbar" id="historyList"></div>
  </div>

  <div class="modal fade calculator-modal" id="calculatorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content" style="background: var(--surface-dark); border-radius: 12px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);">
        <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
          <h5 class="modal-title">快速計算器</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="關閉"></button>
        </div>
        <div class="modal-body">
          <div class="input-group">
            <span class="input-group-text" style="background: var(--accent-dark); border: 1px solid var(--border-color); color: var(--text-primary); min-width: 100px; font-size: 0.85rem;">選取因子值</span>
            <input type="text" id="selectedValue" class="form-control form-control-custom" readonly>
          </div>
          <div class="input-group mt-2">
            <span class="input-group-text" style="background: var(--accent-dark); border: 1px solid var(--border-color); color: var(--text-primary); min-width: 100px; font-size: 0.85rem;">期數 (N)</span>
            <select id="selectedN" class="form-select form-control-custom"></select>
          </div>
          <div class="input-group mt-2">
            <span class="input-group-text" style="background: var(--accent-dark); border: 1px solid var(--border-color); color: var(--text-primary); min-width: 100px; font-size: 0.85rem;">選擇的因子</span>
            <select id="selectedFactor" class="form-select form-control-custom">
              <option value="F/P">終值因子 (F/P)</option>
              <option value="P/F">現值因子 (P/F)</option>
              <option value="A/P">資本回收因子 (A/P)</option>
              <option value="P/A">現值年金因子 (P/A)</option>
              <option value="F/A">終值年金因子 (F/A)</option>
              <option value="A/F">償債基金因子 (A/F)</option>
              <option value="P/G">梯度現值因子 (P/G)</option>
              <option value="A/G">梯度年金因子 (A/G)</option>
            </select>
          </div>
          <hr class="my-2">
          <div class="input-group">
            <span class="input-group-text" style="background: var(--accent-dark); border: 1px solid var(--border-color); color: var(--text-primary); min-width: 100px; font-size: 0.85rem;">輸入金額</span>
            <input type="number" id="inputAmount" class="form-control form-control-custom" 
                   placeholder="請輸入金額" step="100">
          </div>
          <div class="input-group mt-2">
            <span class="input-group-text" style="background: var(--accent-dark); border: 1px solid var(--border-color); color: var(--text-primary); min-width: 100px; font-size: 0.85rem;">計算結果</span>
            <input type="text" id="calculationResult" class="form-control form-control-custom" 
                   style="font-size: 1rem; font-weight: 600; background: var(--accent-dark);" readonly>
          </div>
          <div class="input-group mt-2">
            <span class="input-group-text" style="background: var(--accent-dark); border: 1px solid var(--border-color); color: var(--text-primary); min-width: 100px; font-size: 0.85rem;">複合因子</span>
            <select id="compoundFactor" class="form-select form-control-custom">
              <option value="">無</option>
              <option value="F/P">終值因子 (F/P)</option>
              <option value="P/F">現值因子 (P/F)</option>
              <option value="A/P">資本回收因子 (A/P)</option>
              <option value="P/A">現值年金因子 (P/A)</option>
              <option value="F/A">終值年金因子 (F/A)</option>
              <option value="A/F">償債基金因子 (A/F)</option>
              <option value="P/G">梯度現值因子 (P/G)</option>
              <option value="A/G">梯度年金因子 (A/G)</option>
            </select>
          </div>
          <div class="calculation-flow mt-2" id="calculationFlow" style="padding: 0.5rem; background: var(--accent-dark); border-radius: 6px; font-size: 0.85rem; text-align: center; overflow-x: auto; white-space: nowrap; border: 1px solid var(--border-color);"></div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
          <button type="button" class="btn btn-primary" id="calculateBtn" onclick="performCalculation()">立即計算</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentHighlight = null;
    let historyRecords = [];
    let editingIndex = -1;

    function calculateFactors() {
      const rateInput = document.getElementById('interestRate').value;
      const rate = parseFloat(rateInput) / 100;
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      if (!rate || rate <= 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center py-3">請輸入有效利率以顯示數據</td></tr>';
        return;
      }

      for (let n = 1; n <= 60; n++) {
        const F_P = Math.pow(1 + rate, n);
        const P_F = 1 / F_P;
        const A_P = (rate * F_P) / (F_P - 1);
        const P_A = 1 / A_P;
        const F_A = (F_P - 1) / rate;
        const A_F = rate / (F_P - 1);
        const P_G = ((F_A - n) / (rate * rate)) * P_F;
        const A_G = (1 / rate) - (n / (F_P - 1));

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${n}</td>
          <td>${F_P.toFixed(6)}</td>
          <td>${P_F.toFixed(6)}</td>
          <td>${A_P.toFixed(6)}</td>
          <td>${P_A.toFixed(6)}</td>
          <td>${F_A.toFixed(6)}</td>
          <td>${A_F.toFixed(6)}</td>
          <td>${P_G.toFixed(6)}</td>
          <td>${A_G.toFixed(6)}</td>
        `;
        tbody.appendChild(row);
      }

      const nSelect = document.getElementById('selectedN');
      nSelect.innerHTML = '';
      for (let i = 1; i <= 60; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        nSelect.appendChild(option);
      }
    }

    function searchFactor() {
      const factor = document.getElementById('factorType').value;
      const nValue = document.getElementById('searchN').value;
      const table = document.querySelector('.factor-table');
      
      if (!nValue || nValue < 1 || nValue > 60) {
        alert('請輸入有效的期數 (1-60)');
        return;
      }
      
      const rows = table.rows;
      for (let i = 1; i < rows.length; i++) {
        const cells = rows[i].cells;
        if (cells[0].textContent === nValue) {
          if (currentHighlight) currentHighlight.classList.remove('highlight-cell');
          const headerCells = document.querySelectorAll('.factor-table thead th');
          let headerIndex = -1;
          for (let j = 0; j < headerCells.length; j++) {
            if (headerCells[j].textContent.trim() === factor) {
              headerIndex = j;
              break;
            }
          }
          if (headerIndex !== -1) {
            cells[headerIndex].classList.add('highlight-cell');
            currentHighlight = cells[headerIndex];
            cells[headerIndex].scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
          }
          break;
        }
      }
    }

    function updateFactorValue() {
      const n = document.getElementById('selectedN').value;
      const factor = document.getElementById('selectedFactor').value;
      const rows = document.querySelector('.factor-table').rows;
      for (let i = 1; i < rows.length; i++) {
        if (rows[i].cells[0].textContent === n) {
          const headerCells = document.querySelectorAll('.factor-table thead th');
          let factorIndex = -1;
          for (let j = 0; j < headerCells.length; j++) {
            if (headerCells[j].textContent === factor) {
              factorIndex = j;
              break;
            }
          }
          if (factorIndex !== -1) {
            document.getElementById('selectedValue').value = parseFloat(rows[i].cells[factorIndex].textContent).toFixed(6);
          }
          break;
        }
      }
    }

    function performCalculation() {
      const value = parseFloat(document.getElementById('selectedValue').value);
      const amount = parseFloat(document.getElementById('inputAmount').value);
      const factor = document.getElementById('selectedFactor').value;
      const n = document.getElementById('selectedN').value;
      const compoundFactor = document.getElementById('compoundFactor').value;
      const rate = parseFloat(document.getElementById('interestRate').value) / 100;
      const resultField = document.getElementById('calculationFlow');

      if (isNaN(value) || isNaN(amount)) {
        resultField.innerHTML = '請輸入有效數值以查看計算流程';
        alert('請輸入有效金額和因子值');
        return;
      }

      let result = value * amount;
      let compoundResult = null;
      let compoundValue = null;

      if (compoundFactor) {
        const rows = document.querySelector('.factor-table').rows;
        for (let i = 1; i < rows.length; i++) {
          if (rows[i].cells[0].textContent === n) {
            const headerCells = document.querySelectorAll('.factor-table thead th');
            let compoundIndex = -1;
            for (let j = 0; j < headerCells.length; j++) {
              if (headerCells[j].textContent === compoundFactor) {
                compoundIndex = j;
                break;
              }
            }
            if (compoundIndex !== -1) {
              compoundValue = parseFloat(rows[i].cells[compoundIndex].textContent);
              compoundResult = result * compoundValue;
            }
            break;
          }
        }
      }

      const finalResult = compoundResult || result;
      document.getElementById('calculationResult').value = finalResult.toLocaleString('zh-Hant', { maximumFractionDigits: 4 });

      let flowHTML = `<span style="padding: 0.4rem 0.8rem; background: #333; border-radius: 4px; margin: 0 0.2rem;">${amount.toLocaleString('zh-Hant')}</span>`;
      flowHTML += `<span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; color: var(--primary-color); margin: 0 0.2rem; background: rgba(255, 172, 28, 0.1); border-radius: 50%;">×</span><span style="padding: 0.4rem 0.8rem; background: #333; border-radius: 4px; margin: 0 0.2rem;">${factor} (${value.toFixed(6)})</span>`;
      if (compoundFactor && compoundValue) {
        flowHTML += `<span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; color: var(--primary-color); margin: 0 0.2rem; background: rgba(255, 172, 28, 0.1); border-radius: 50%;">×</span><span style="padding: 0.4rem 0.8rem; background: #333; border-radius: 4px; margin: 0 0.2rem;">${compoundFactor} (${compoundValue.toFixed(6)})</span>`;
      }
      flowHTML += `<span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; color: var(--primary-color); margin: 0 0.2rem; background: rgba(255, 172, 28, 0.1); border-radius: 50%;">=</span><span style="padding: 0.4rem 0.8rem; background: #333; border-radius: 4px; margin: 0 0.2rem;">${finalResult.toLocaleString('zh-Hant', { maximumFractionDigits: 4 })}</span>`;
      resultField.innerHTML = flowHTML;

      const record = {
        rate: rate * 100,
        n,
        amount,
        factor,
        factorValue: value,
        compoundFactor: compoundFactor || '無',
        compoundValue: compoundValue,
        result: finalResult
      };

      if (editingIndex === -1) {
        historyRecords.unshift(record);
      } else {
        historyRecords[editingIndex] = record;
        editingIndex = -1;
        document.getElementById('calculateBtn').textContent = '立即計算';
      }
      
      updateHistoryList();
    }

    function filterHistory() {
      const searchValue = document.getElementById('historySearch').value.toLowerCase();
      const filteredRecords = historyRecords.filter(record => 
        record.rate.toString().includes(searchValue) ||
        record.n.toString().includes(searchValue) ||
        record.factor.toLowerCase().includes(searchValue) ||
        record.compoundFactor.toLowerCase().includes(searchValue)
      );
      updateHistoryList(filteredRecords);
    }

    function updateHistoryList(filteredRecords = historyRecords) {
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = '';

      filteredRecords.forEach((record, index) => {
        const item = document.createElement('div');
        item.style.cssText = 'background: var(--accent-dark); padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; border: 1px solid var(--border-color); font-size: 0.9rem;';
        item.innerHTML = `
          <div>利率: ${record.rate.toFixed(2)}%</div>
          <div>期數: ${record.n}</div>
          <div>金額: ${record.amount.toLocaleString('zh-Hant')}</div>
          <div>因子: ${record.factor}${record.compoundFactor !== '無' ? ` × ${record.compoundFactor}` : ''}</div>
          <div>結果: ${record.result.toLocaleString('zh-Hant', { maximumFractionDigits: 4 })}</div>
          <div style="margin-top: 0.5rem; padding: 0.4rem; background: #333; border-radius: 4px; text-align: center; overflow-x: auto; white-space: nowrap;">
            <span style="padding: 0.4rem 0.8rem; background: #444; border-radius: 4px; margin: 0 0.2rem;">${record.amount.toLocaleString('zh-Hant')}</span>
            <span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; color: var(--primary-color); margin: 0 0.2rem; background: rgba(255, 172, 28, 0.1); border-radius: 50%;">×</span>
            <span style="padding: 0.4rem 0.8rem; background: #444; border-radius: 4px; margin: 0 0.2rem;">${record.factor} (${record.factorValue.toFixed(6)})</span>
            ${record.compoundFactor !== '無' ? `<span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; color: var(--primary-color); margin: 0 0.2rem; background: rgba(255, 172, 28, 0.1); border-radius: 50%;">×</span><span style="padding: 0.4rem 0.8rem; background: #444; border-radius: 4px; margin: 0 0.2rem;">${record.compoundFactor} (${record.compoundValue.toFixed(6)})</span>` : ''}
            <span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; color: var(--primary-color); margin: 0 0.2rem; background: rgba(255, 172, 28, 0.1); border-radius: 50%;">=</span>
            <span style="padding: 0.4rem 0.8rem; background: #444; border-radius: 4px; margin: 0 0.2rem;">${record.result.toLocaleString('zh-Hant', { maximumFractionDigits: 4 })}</span>
          </div>
          <div style="margin-top: 0.5rem;">
            <button class="btn btn-sm btn-outline-primary" onclick="editRecord(${index})">編輯</button>
            <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete(${index})">刪除</button>
          </div>
        `;
        historyList.appendChild(item);
      });
    }

    function editRecord(index) {
      const record = historyRecords[index];
      editingIndex = index;
      
      document.getElementById('inputAmount').value = record.amount;
      document.getElementById('interestRate').value = record.rate;
      document.getElementById('selectedN').value = record.n;
      document.getElementById('selectedFactor').value = record.factor;
      document.getElementById('compoundFactor').value = record.compoundFactor === '無' ? '' : record.compoundFactor;
      
      calculateFactors();
      setTimeout(() => {
        updateFactorValue();
        const modal = new bootstrap.Modal(document.getElementById('calculatorModal'));
        document.getElementById('calculateBtn').textContent = '更新記錄';
        modal.show();
      }, 350);
    }

    function confirmDelete(index) {
      if (confirm('確定要刪除這條歷史記錄嗎？')) {
        historyRecords.splice(index, 1);
        updateHistoryList();
      }
    }

    function confirmClearHistory() {
      if (confirm('確定要清空所有歷史記錄嗎？此操作無法撤銷。')) {
        historyRecords = [];
        updateHistoryList();
      }
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('historySidebar');
      sidebar.classList.toggle('active');
    }

    function debounce(func, timeout = 300) {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => func.apply(this, args), timeout);
      };
    }

    document.getElementById('interestRate').addEventListener('input', debounce(calculateFactors, 300));
    document.getElementById('selectedN').addEventListener('change', updateFactorValue);
    document.getElementById('selectedFactor').addEventListener('change', updateFactorValue);

    document.querySelector('.factor-table').addEventListener('click', (e) => {
      if (e.target.tagName === 'TD' && e.target.cellIndex !== 0) {
        editingIndex = -1;
        document.getElementById('calculateBtn').textContent = '立即計算';
        const modal = new bootstrap.Modal(document.getElementById('calculatorModal'));
        const row = e.target.parentElement;
        document.getElementById('selectedValue').value = parseFloat(e.target.textContent).toFixed(6);
        document.getElementById('selectedN').value = row.cells[0].textContent;
        document.getElementById('selectedFactor').value = document.querySelectorAll('.factor-table thead th')[e.target.cellIndex].textContent;
        document.getElementById('calculationFlow').innerHTML = '請輸入金額並計算以查看流程';
        modal.show();
        document.getElementById('inputAmount').focus();
      }
    });

    calculateFactors();
  </script>
</body>
</html>