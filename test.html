<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OC曲線分析工具</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.3.3/echarts.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary: #FF9800;
      --primary-light: #FFB74D;
      --primary-dark: #F57C00;
      --background: #1E2329;
      --surface: #2D3439;
      --surface-hover: #37474F;
      --text-primary: #FFFFFF;
      --text-secondary: #B0BEC5;
      --error: #EF5350;
      --success: #66BB6A;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }

    .container {
      max-width: 1200px;
      width: 95%;
      margin: 2rem auto;
      padding: 2rem;
      background: var(--surface);
      border-radius: 1rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .header {
      text-align: center;
      margin-bottom: 2.5rem;
      position: relative;
      padding-bottom: 1rem;
    }

    .header:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 3px;
      background: var(--primary);
      border-radius: 3px;
    }

    .header h1 {
      font-size: 2.2rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }

    .header p {
      color: var(--text-secondary);
      max-width: 700px;
      margin: 1rem auto;
      font-size: 1rem;
    }

    .input-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }

    .input-wrapper {
      position: relative;
      background: rgba(255,255,255,0.05);
      border-radius: 0.75rem;
      padding: 1.2rem;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }

    .input-wrapper:hover {
      background: var(--surface-hover);
      transform: translateY(-2px);
    }

    .input-wrapper:focus-within {
      box-shadow: 0 0 0 2px var(--primary);
      border-color: var(--primary);
    }

    .input-header {
      display: flex;
      align-items: center;
      margin-bottom: 0.8rem;
    }

    .input-header label {
      font-weight: 500;
      font-size: 1rem;
      color: var(--text-primary);
    }

    .info-icon {
      color: var(--primary-light);
      margin-left: 0.5rem;
      cursor: help;
      font-size: 0.9rem;
      transition: color 0.2s ease;
    }

    .info-icon:hover {
      color: var(--primary);
    }

    .tooltip-text {
      visibility: hidden;
      background-color: rgba(0,0,0,0.9);
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 0.8rem;
      position: absolute;
      z-index: 10;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      width: 220px;
      font-size: 0.9rem;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .tooltip-text::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: rgba(0,0,0,0.9) transparent transparent transparent;
    }

    .info-icon:hover + .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    .input-field {
      position: relative;
    }

    input {
      width: 100%;
      padding: 1rem;
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 0.5rem;
      color: var(--primary);
      font-size: 1.2rem;
      transition: all 0.3s ease;
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      background: rgba(0,0,0,0.3);
    }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type=number] {
      -moz-appearance: textfield;
    }

    .input-field .unit {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      pointer-events: none;
    }

    .error-message {
      color: var(--error);
      font-size: 0.85rem;
      margin-top: 0.5rem;
      display: none;
    }

    .button-group {
      text-align: center;
      margin: 2.5rem 0;
    }

    button {
      background: var(--primary);
      color: white;
      padding: 1rem 2.5rem;
      border: none;
      border-radius: 0.75rem;
      font-size: 1.1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.8rem;
      box-shadow: 0 4px 12px rgba(255,152,0,0.3);
    }

    button:hover {
      background: var(--primary-dark);
      transform: translateY(-3px);
      box-shadow: 0 7px 15px rgba(255,152,0,0.4);
    }

    button:active {
      transform: translateY(-1px);
    }

    button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .chart-section {
      position: relative;
      margin: 2rem 0;
      padding: 1.5rem;
      background: var(--background);
      border-radius: 1rem;
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.2);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .chart-section:hover {
      box-shadow: inset 0 2px 15px rgba(0,0,0,0.3);
    }

    .chart-container {
      height: 500px;
      width: 100%;
    }

    .custom-tooltip {
      position: absolute;
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 0.8rem 1.2rem;
      border-radius: 0.5rem;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 10;
      font-size: 0.95rem;
      border-left: 3px solid var(--primary);
      max-width: 250px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .chart-info {
      color: var(--text-secondary);
      font-size: 0.95rem;
      margin-top: 1.5rem;
      padding: 1rem;
      background: rgba(0,0,0,0.2);
      border-radius: 0.5rem;
      border-left: 3px solid var(--primary);
    }

    .chart-info p {
      margin-bottom: 0.5rem;
    }

    .chart-info p:last-child {
      margin-bottom: 0;
    }

    .key-points {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
      animation: fadeIn 0.5s ease-in-out;
      animation-delay: 0.3s;
      animation-fill-mode: both;
    }

    .key-point {
      background: rgba(255,255,255,0.05);
      padding: 1.2rem;
      border-radius: 0.75rem;
      text-align: center;
      transition: all 0.3s ease;
    }

    .key-point:hover {
      background: rgba(255,255,255,0.08);
      transform: translateY(-3px);
    }

    .key-point-title {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    .key-point-value {
      font-size: 1.5rem;
      color: var(--primary);
      font-weight: bold;
    }

    footer {
      text-align: center;
      padding: 1.5rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-top: auto;
    }

    @media (max-width: 768px) {
      .container {
        padding: 1.5rem;
        margin: 1rem auto;
        width: 92%;
      }
      
      .header h1 {
        font-size: 1.8rem;
      }
      
      button {
        width: 100%;
        justify-content: center;
      }
      
      .chart-container {
        height: 350px;
      }
    }

    /* Animation for chart points on hover */
    .point-highlight {
      transform: scale(1.5);
      transition: transform 0.2s ease;
    }
    
    /* Loader animation */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loader {
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>
        <i class="fas fa-chart-line" style="color: var(--primary);"></i>
        OC曲線分析工具
      </h1>
      <p>分析抽樣檢驗計劃的運作特性曲線（Operating Characteristic Curve），評估品質檢驗計劃的效能。</p>
    </div>

    <div class="input-section">
      <div class="input-wrapper">
        <div class="input-header">
          <label for="sampleSize">樣本大小 (n)</label>
          <i class="fas fa-info-circle info-icon"></i>
          <div class="tooltip-text">每次抽樣檢驗時抽取的產品數量。增加樣本大小可提高檢測能力，但會增加檢驗成本。</div>
        </div>
        <div class="input-field">
          <input type="number" id="sampleSize" value="50" min="1" step="1" required>
          <span class="unit">件</span>
        </div>
        <div class="error-message" id="sampleSizeError"></div>
      </div>

      <div class="input-wrapper">
        <div class="input-header">
          <label for="acceptanceNumber">允收數量 (c)</label>
          <i class="fas fa-info-circle info-icon"></i>
          <div class="tooltip-text">允許的最大不合格品數量。超過此數量將拒收整批產品。较小的允收數會使檢驗更嚴格。</div>
        </div>
        <div class="input-field">
          <input type="number" id="acceptanceNumber" value="2" min="0" step="1" required>
          <span class="unit">件</span>
        </div>
        <div class="error-message" id="acceptanceNumberError"></div>
      </div>
    </div>

    <div class="button-group">
      <button id="generateButton" onclick="generateOC()">
        <i class="fas fa-chart-area"></i>
        生成OC曲線
      </button>
    </div>

    <div class="chart-section">
      <div id="ocChart" class="chart-container"></div>
      <div class="custom-tooltip" id="chartTooltip"></div>
      
      <div class="chart-info">
        <p><i class="fas fa-info-circle" style="color: var(--primary-light);"></i> OC曲線顯示在不同不良率(p)下的接受概率(Pa)。</p>
        <p><i class="fas fa-lightbulb" style="color: var(--primary-light);"></i> 理想的OC曲線應在可接受品質水平(AQL)點保持高接受概率，並在限制性不良品率(LTPD)點快速下降。</p>
      </div>
      
      <div class="key-points" id="keyPointsContainer" style="display: none;">
        <div class="key-point">
          <div class="key-point-title">生產者風險點 (α)</div>
          <div class="key-point-value" id="producerRisk">--</div>
        </div>
        <div class="key-point">
          <div class="key-point-title">消費者風險點 (β)</div>
          <div class="key-point-value" id="consumerRisk">--</div>
        </div>
        <div class="key-point">
          <div class="key-point-title">檢驗辨別力 (pd₅₀)</div>
          <div class="key-point-value" id="discriminationPower">--</div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>© 2025 OC曲線分析工具 | 版本 2.0</p>
  </footer>

  <script>
    // 優化：使用一個統一的狀態管理
    const state = {
      sampleSize: 50,
      acceptanceNumber: 2,
      isCalculating: false,
      chartInstance: null,
      logFactorialCache: [],
      defectRates: [],
      acceptanceProbabilities: []
    };

    // 初始化輸入欄位驗證
    function initInputValidation() {
      const sampleSizeInput = document.getElementById('sampleSize');
      const acceptanceNumberInput = document.getElementById('acceptanceNumber');
      
      sampleSizeInput.addEventListener('input', validateInputs);
      acceptanceNumberInput.addEventListener('input', validateInputs);
      
      // 初始驗證
      validateInputs();
    }
    
    // 驗證輸入參數
    function validateInputs() {
      const sampleSizeInput = document.getElementById('sampleSize');
      const acceptanceNumberInput = document.getElementById('acceptanceNumber');
      const generateButton = document.getElementById('generateButton');
      
      const sampleSize = parseInt(sampleSizeInput.value);
      const acceptanceNumber = parseInt(acceptanceNumberInput.value);
      
      const sampleSizeError = document.getElementById('sampleSizeError');
      const acceptanceNumberError = document.getElementById('acceptanceNumberError');
      
      // 重置錯誤訊息
      sampleSizeError.style.display = 'none';
      acceptanceNumberError.style.display = 'none';
      sampleSizeInput.style.borderColor = '';
      acceptanceNumberInput.style.borderColor = '';
      
      let hasError = false;
      
      // 驗證樣本大小
      if (isNaN(sampleSize) || sampleSize <= 0) {
        sampleSizeError.textContent = '請輸入大於0的整數';
        sampleSizeError.style.display = 'block';
        sampleSizeInput.style.borderColor = 'var(--error)';
        hasError = true;
      }
      
      // 驗證允收數量
      if (isNaN(acceptanceNumber) || acceptanceNumber < 0) {
        acceptanceNumberError.textContent = '請輸入非負整數';
        acceptanceNumberError.style.display = 'block';
        acceptanceNumberInput.style.borderColor = 'var(--error)';
        hasError = true;
      } else if (acceptanceNumber > sampleSize) {
        acceptanceNumberError.textContent = '允收數量不能大於樣本大小';
        acceptanceNumberError.style.display = 'block';
        acceptanceNumberInput.style.borderColor = 'var(--error)';
        hasError = true;
      }
      
      // 更新按鈕狀態
      generateButton.disabled = hasError;
      
      return !hasError;
    }

    // 計算對數階乘（log(n!)），使用緩存以提高計算穩定性和效率
    function logFactorial(n) {
      if (n === 0 || n === 1) return 0;
      if (state.logFactorialCache[n]) return state.logFactorialCache[n];

      let logFact = state.logFactorialCache[n - 1] || 0;
      for (let i = (state.logFactorialCache.length || 2); i <= n; i++) {
        logFact += Math.log(i);
        state.logFactorialCache[i] = logFact;
      }
      return logFact;
    }

    // 計算二項分佈的機率，使用對數方法以防止溢出
    function binomialProbability(n, x, p) {
      if (x > n) return 0;
      if (p === 0) return x === 0 ? 1 : 0;
      if (p === 1) return x === n ? 1 : 0;

      const logC = logFactorial(n) - logFactorial(x) - logFactorial(n - x);
      const logP = x * Math.log(p) + (n - x) * Math.log(1 - p);
      const logProb = logC + logP;

      // 防止指數運算溢出
      if (logProb < -700) return 0;
      return Math.exp(logProb);
    }

    // 計算接受概率，累積 P(X=0) 到 P(X=c)
    function acceptanceProbability(n, c, p) {
      let Pa = 0;
      for (let x = 0; x <= c; x++) {
        const prob = binomialProbability(n, x, p);
        Pa += prob;
      }
      return Pa > 1 ? 1 : Pa;
    }

    // 計算重要參數
    function calculateKeyPoints(sampleSize, acceptanceNumber, defectRates, acceptanceProbabilities) {
      // 生產者風險點：在 AQL 處的拒收概率
      // 假設 AQL = 1%
      const aqlIndex = defectRates.findIndex(p => p >= 0.01);
      const producerRisk = 1 - acceptanceProbabilities[aqlIndex];
      
      // 消費者風險點：在 LTPD 處的接受概率
      // 假設 LTPD = 10%
      const ltpdIndex = defectRates.findIndex(p => p >= 0.10);
      const consumerRisk = acceptanceProbabilities[ltpdIndex];
      
      // 檢驗辨別力：Pa = 50% 時的不良率
      const pd50Index = acceptanceProbabilities.findIndex(pa => pa <= 0.5);
      const discriminationPower = defectRates[pd50Index];
      
      return {
        producerRisk: (producerRisk * 100).toFixed(1) + '%',
        consumerRisk: (consumerRisk * 100).toFixed(1) + '%',
        discriminationPower: (discriminationPower * 100).toFixed(2) + '%'
      };
    }
    
    // 更新關鍵點資訊
    function updateKeyPoints(keyPoints) {
      document.getElementById('producerRisk').textContent = keyPoints.producerRisk;
      document.getElementById('consumerRisk').textContent = keyPoints.consumerRisk;
      document.getElementById('discriminationPower').textContent = keyPoints.discriminationPower;
      document.getElementById('keyPointsContainer').style.display = 'grid';
    }

    // 生成OC曲線，使用 ECharts 進行可視化
    function generateOC() {
      if (!validateInputs()) return;
      
      // 更新按鈕狀態
      const button = document.getElementById('generateButton');
      button.innerHTML = '<i class="fas fa-spinner fa-spin loader"></i> 計算中...';
      button.disabled = true;
      state.isCalculating = true;

      // 獲取參數
      state.sampleSize = parseInt(document.getElementById('sampleSize').value);
      state.acceptanceNumber = parseInt(document.getElementById('acceptanceNumber').value);

      // 在非阻塞的方式中使用 setTimeout 進行計算
      setTimeout(() => {
        try {
          state.defectRates = [];
          state.acceptanceProbabilities = [];

          // 以更細的步長計算曲線 (0.005 -> 0.002)
          for (let p = 0; p <= 0.2; p += 0.002) {
            state.defectRates.push(p);
            const pa = acceptanceProbability(state.sampleSize, state.acceptanceNumber, p);
            state.acceptanceProbabilities.push(pa > 1 ? 1 : pa);
          }

          // 繪製曲線
          drawChart();
          
          // 計算並顯示重要參數
          const keyPoints = calculateKeyPoints(
            state.sampleSize, 
            state.acceptanceNumber, 
            state.defectRates, 
            state.acceptanceProbabilities
          );
          updateKeyPoints(keyPoints);

          // 重置按鈕狀態
          button.innerHTML = '<i class="fas fa-chart-area"></i> 重新生成曲線';
          button.disabled = false;
          state.isCalculating = false;
        } catch (error) {
          console.error('計算錯誤：', error);
          button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 重新嘗試';
          button.disabled = false;
          state.isCalculating = false;
          alert('計算過程中發生錯誤，請調整參數後重試。');
        }
      }, 50);
    }

    // 使用 ECharts 繪製 OC 曲線
    function drawChart() {
      const chartDom = document.getElementById('ocChart');
      
      // 如果已有圖表實例，則銷毀
      if (state.chartInstance) {
        state.chartInstance.dispose();
      }
      
      state.chartInstance = echarts.init(chartDom);
      
      // 創建兩條曲線：一條主曲線和一條輔助曲線用來標示關鍵點
      const option = {
        title: {
          text: 'OC曲線分析',
          subtext: `樣本數: ${state.sampleSize}, 允收數: ${state.acceptanceNumber}`,
          left: 'center',
          textStyle: {
            color: '#FF9800',
            fontSize: 18
          },
          subtextStyle: {
            color: '#B0BEC5'
          }
        },
        tooltip: {
          trigger: 'axis',
          show: false // 關閉內建提示，使用自訂提示
        },
        grid: {
          left: '5%',
          right: '5%',
          bottom: '8%',
          top: '15%',
          containLabel: true
        },
        xAxis: {
          type: 'value',
          name: '不良率 (p)',
          nameLocation: 'middle',
          nameGap: 35,
          axisLabel: {
            formatter: value => (value * 100).toFixed(1) + '%',
            color: '#B0BEC5'
          },
          min: 0,
          max: 0.2,
          splitLine: {
            show: true,
            lineStyle: {
              color: 'rgba(255,255,255,0.1)',
              type: 'dashed'
            }
          },
          axisLine: {
            lineStyle: {
              color: '#FF9800'
            }
          }
        },
        yAxis: {
          type: 'value',
          name: '接受概率 (Pa)',
          nameLocation: 'middle',
          nameGap: 45,
          axisLabel: {
            formatter: value => (value * 100).toFixed(0) + '%',
            color: '#B0BEC5'
          },
          min: 0,
          max: 1,
          splitLine: {
            show: true,
            lineStyle: {
              color: 'rgba(255,255,255,0.1)',
              type: 'dashed'
            }
          },
          axisLine: {
            lineStyle: {
              color: '#FF9800'
            }
          }
        },
        series: [
          {
            name: 'OC曲線',
            type: 'line',
            smooth: true,
            showSymbol: false,
            emphasis: {
              focus: 'series',
              lineStyle: {
                width: 3
              }
            },
            data: state.defectRates.map((p, i) => [p, state.acceptanceProbabilities[i]]),
            lineStyle: {
              color: '#FF9800',
              width: 2.5
            },
            areaStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                { offset: 0, color: 'rgba(255, 152, 0, 0.5)' },
                { offset: 1, color: 'rgba(255, 152, 0, 0.05)' }
              ])
            },
            markPoint: {
              symbolSize: 60,
              data: [
                { type: 'max', name: '最大值', symbolOffset: [0, -20] },
                { 
                  name: '接受概率50%',
                  coord: [state.defectRates.find((_, i) => state.acceptanceProbabilities[i] <= 0.5), 0.5],
                  itemStyle: { color: '#FF9800' }
                }
              ],
              label: {
                formatter: (params) => {
                  if (params.name === '接受概率50%') {
                    const p = params.data.coord[0];
                    return `pd₅₀\n${(p * 100).toFixed(1)}%`;
                  }
                  return params.name;
                },
                fontSize: 12
              }
            },
            markLine: {
              symbol: ['none', 'none'],
              label: { show: true },
              data: [
                { 
                  name: 'AQL',
                  xAxis: 0.01,
                  lineStyle: { color: '#66BB6A' },
                  label: { position: 'middle', formatter: 'AQL (1%)', color: '#66BB6A' }
                },
                {
                  name: 'LTPD',
                  xAxis: 0.10,
                  lineStyle: { color: '#EF5350' },
                  label: { position: 'middle', formatter: 'LTPD (10%)', color: '#EF5350' }
                },
                {
                  name: '50%接受率',
                  yAxis: 0.5,
                  lineStyle: { type: 'dashed', color: '#B0BEC5' }
                }
              ]
            }
          }
        ],
        animation: true,
        animationDuration: 1000,
        animationEasing: 'cubicOut',
        backgroundColor: '#1E2329'
      };
      
      state.chartInstance.setOption(option);
      
      // 圖表互動功能
      initChartInteraction();
    }
    
    // 初始化圖表互動功能
    function initChartInteraction() {
      const chartDom = document.getElementById('ocChart');
      const tooltip = document.getElementById('chartTooltip');
      
      // 設備類型檢測
      const isMobile = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
      
      // 滑鼠懸停效果
      state.chartInstance.on('mouseover', function() {
        chartDom.style.cursor = 'pointer';
      });
      
      state.chartInstance.on('mouseout', function() {
        chartDom.style.cursor = 'default';
      });
      
      if (isMobile) {
        // 手機端點擊顯示提示框
        state.chartInstance.on('click', function(params) {
          if (params.componentType === 'series') {
            const [p, pa] = params.data;
            
            // 計算提示位置
            const x = params.event.offsetX;
            const y = params.event.offsetY;
            
            // 顯示提示內容
            tooltip.innerHTML = `
              <div style="margin-bottom: 5px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px;">
                點位資訊
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                <span>不良率 (p):</span>
                <span style="font-weight: bold; color: #FF9800;">${(p * 100).toFixed(2)}%</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span>接受概率 (Pa):</span>
                <span style="font-weight: bold; color: #FF9800;">${(pa * 100).toFixed(2)}%</span>
              </div>
            `;
            
            // 設置提示框位置
            tooltip.style.left = (x + 10) + 'px';
            tooltip.style.top = (y - 10) + 'px';
            tooltip.style.opacity = 1;
            
            // 3秒後自動隱藏
            setTimeout(() => {
              tooltip.style.opacity = 0;
            }, 3000);
          }
        });
      } else {
        // 桌面端滑鼠移動顯示提示框
        let hideTimeout;
        
        state.chartInstance.on('mousemove', function(params) {
          if (params.componentType === 'series') {
            clearTimeout(hideTimeout);
            
            const [p, pa] = params.data;
            
            // 計算提示位置
            const x = params.event.offsetX;
            const y = params.event.offsetY;
            
            // 顯示提示內容
            tooltip.innerHTML = `
              <div style="margin-bottom: 5px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px;">
                點位資訊
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                <span>不良率 (p):</span>
                <span style="font-weight: bold; color: #FF9800;">${(p * 100).toFixed(2)}%</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span>接受概率 (Pa):</span>
                <span style="font-weight: bold; color: #FF9800;">${(pa * 100).toFixed(2)}%</span>
              </div>
            `;
            
            // 設置提示框位置（避免超出邊界）
            const tooltipWidth = 200; // 預估寬度
            const tooltipHeight = 100; // 預估高度
            const chartRect = chartDom.getBoundingClientRect();
            
            let posX = (x + tooltipWidth > chartRect.width) ? (x - tooltipWidth - 10) : (x + 10);
            let posY = (y + tooltipHeight > chartRect.height) ? (y - tooltipHeight - 10) : (y + 10);
            
            posX = Math.max(10, posX);
            posY = Math.max(10, posY);
            
            tooltip.style.left = posX + 'px';
            tooltip.style.top = posY + 'px';
            tooltip.style.opacity = 1;
          }
        });
        
        state.chartInstance.on('mouseout', function() {
          hideTimeout = setTimeout(() => {
            tooltip.style.opacity = 0;
          }, 200);
        });
      }
    }
    
    // 導出圖表為圖片
    function exportChart() {
      if (!state.chartInstance) return;
      
      try {
        // 獲取圖表的 DataURL
        const dataURL = state.chartInstance.getDataURL({
          type: 'png',
          pixelRatio: 2,
          backgroundColor: '#1E2329'
        });
        
        // 創建下載連結
        const link = document.createElement('a');
        link.href = dataURL;
        link.download = `OC曲線_n${state.sampleSize}_c${state.acceptanceNumber}_${new Date().toISOString().slice(0, 10)}.png`;
        
        // 觸發下載
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (error) {
        console.error('匯出圖表時發生錯誤：', error);
        alert('匯出圖表失敗，請稍後再試。');
      }
    }
    
    // 添加鍵盤快捷鍵
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', function(e) {
        // Ctrl+Enter 生成圖表
        if (e.ctrlKey && e.key === 'Enter') {
          e.preventDefault();
          generateOC();
        }
        
        // Ctrl+S 導出圖表
        if (e.ctrlKey && e.key === 's') {
          e.preventDefault();
          exportChart();
        }
      });
    }
    
    // 調整圖表大小以適應窗口變化
    function handleResize() {
      window.addEventListener('resize', function() {
        if (state.chartInstance) {
          state.chartInstance.resize();
        }
      });
    }
    
    // 初始化所有事件監聽
    function initEvents() {
      // 初始化輸入欄位驗證
      initInputValidation();
      
      // 設置鍵盤快捷鍵
      setupKeyboardShortcuts();
      
      // 處理窗口大小變化
      handleResize();
    }
    
    // 網頁載入完成後執行初始化
    window.onload = function() {
      // 初始化所有事件監聽
      initEvents();
      
      // 生成初始圖表
      generateOC();
    };
  </script>
</body>
</html>