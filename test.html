<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>工程經濟現金流圖 - 優化版</title>
  <style>
    /* Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft JhengHei', 'PingFang TC', 'Heiti TC', sans-serif;
      background-color: #f8f9fa;
      color: #333;
      line-height: 1.6;
      padding: 20px;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    
    header {
      background: #3498db;
      color: #fff;
      padding: 20px;
      text-align: center;
    }
    
    header h1 {
      font-size: 24px;
    }
    
    .content {
      padding: 20px;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
      background: #f1f8ff;
      padding: 15px;
      border-radius: 6px;
    }
    
    .control-group {
      flex: 1;
      min-width: 150px;
    }
    
    .control-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
    }
    
    .control-group input, 
    .control-group select, 
    .control-group button {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .control-group button {
      background: #3498db;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    .control-group button:hover {
      background: #2980b9;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    
    .data-table th, .data-table td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
    }
    
    .data-table th {
      background: #f2f2f2;
    }
    
    .data-table td input {
      width: 80%;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    
    .data-row:hover {
      background-color: #f5f5f5;
    }
    
    svg {
      width: 100%;
      height: auto;
      margin-bottom: 20px;
    }
    
    .info-panel {
      background: #f9f9f9;
      padding: 15px;
      border-left: 5px solid #3498db;
      margin-bottom: 20px;
      font-size: 16px;
    }
    
    .info-panel div {
      margin-bottom: 10px;
    }
    
    .value-positive {
      color: #27ae60;
      font-weight: bold;
    }
    
    .value-negative {
      color: #e74c3c;
      font-weight: bold;
    }
    
    .legend {
      display: flex;
      gap: 20px;
      padding: 10px 0;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
    }
    
    .legend-color {
      width: 15px;
      height: 15px;
      border-radius: 3px;
    }
    
    @media (max-width: 768px) {
      .controls {
        flex-direction: column;
      }
      .control-group {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>工程經濟現金流圖</h1>
    </header>
    <div class="content">
      <div class="controls">
        <div class="control-group">
          <label for="project-name">專案名稱</label>
          <input type="text" id="project-name" value="工程專案A" />
        </div>
        <div class="control-group">
          <label for="interest-rate">利率 (%)</label>
          <input type="number" id="interest-rate" value="5" min="0" step="0.1" />
        </div>
        <div class="control-group">
          <label for="view-type">圖表類型</label>
          <select id="view-type">
            <option value="standard">標準現金流圖</option>
            <option value="cumulative">累計現金流圖</option>
          </select>
        </div>
        <div class="control-group">
          <label>&nbsp;</label>
          <button id="calculate-npv">計算淨現值 (NPV)</button>
        </div>
      </div>
      
      <table class="data-table">
        <thead>
          <tr>
            <th>時間 (年)</th>
            <th>0</th>
            <th>1</th>
            <th>2</th>
            <th>3</th>
            <th>4</th>
            <th><button id="add-year">+</button></th>
          </tr>
        </thead>
        <tbody>
          <tr class="data-row">
            <td>現金流量 ($)</td>
            <td><input type="number" class="flow-input" data-year="0" value="-400" /></td>
            <td><input type="number" class="flow-input" data-year="1" value="200" /></td>
            <td><input type="number" class="flow-input" data-year="2" value="200" /></td>
            <td><input type="number" class="flow-input" data-year="3" value="200" /></td>
            <td><input type="number" class="flow-input" data-year="4" value="300" /></td>
            <td></td>
          </tr>
        </tbody>
      </table>
      
      <svg id="cashflowSvg" width="850" height="400">
        <defs>
          <!-- 時間軸箭頭 -->
          <marker id="axisArrow" markerWidth="8" markerHeight="8" refX="0" refY="4" orient="auto">
            <path d="M0,8 L8,4 L0,0 Z" fill="#333" />
          </marker>
          <!-- 累計流量線的漸變 -->
          <linearGradient id="cumulativeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#3498db" />
            <stop offset="100%" stop-color="#9b59b6" />
          </linearGradient>
        </defs>
      </svg>
      
      <div id="results" class="info-panel">
        <div>專案淨現值 (NPV): <span id="npv-value">--</span></div>
        <div>回收期 (年): <span id="payback-period">--</span></div>
      </div>
      
      <div class="legend">
        <div class="legend-item">
          <div class="legend-color" style="background-color: #27ae60;"></div>
          <span>現金流入</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #e74c3c;"></div>
          <span>現金流出</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: linear-gradient(to right, #3498db, #9b59b6);"></div>
          <span>累計現金流</span>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // 初始資料
    let times = [0, 1, 2, 3, 4];
    let flows = [-400, 200, 200, 200, 300];
    
    // 主要繪圖參數
    const svg = document.getElementById("cashflowSvg");
    const xStart = 70, xEnd = 800, baseY = 200;
    const scale = 0.25; // 縮放比例
    
    // DOM 元素綁定
    const npvButton = document.getElementById("calculate-npv");
    const interestRateInput = document.getElementById("interest-rate");
    const addYearButton = document.getElementById("add-year");
    const viewTypeSelect = document.getElementById("view-type");
    const npvValue = document.getElementById("npv-value");
    const paybackPeriod = document.getElementById("payback-period");
    
    // 初始繪製圖表
    drawCashflowDiagram();
    
    // 事件監聽器
    npvButton.addEventListener("click", calculateNPV);
    addYearButton.addEventListener("click", addYear);
    viewTypeSelect.addEventListener("change", drawCashflowDiagram);
    document.querySelectorAll('.flow-input').forEach(input => {
      input.addEventListener('change', updateFlow);
    });
    
    // 更新現金流資料
    function updateFlow(e) {
      const year = parseInt(e.target.dataset.year);
      const value = parseFloat(e.target.value);
      flows[year] = value;
      drawCashflowDiagram();
    }
    
    // 增加年份
    function addYear() {
      const newYear = times.length;
      times.push(newYear);
      flows.push(0);
      
      // 更新表格
      const headerRow = document.querySelector('.data-table thead tr');
      const dataRow = document.querySelector('.data-table tbody tr');
      
      const th = document.createElement('th');
      th.textContent = newYear;
      headerRow.insertBefore(th, headerRow.lastElementChild);
      
      const td = document.createElement('td');
      const input = document.createElement('input');
      input.type = 'number';
      input.className = 'flow-input';
      input.dataset.year = newYear;
      input.value = '0';
      input.addEventListener('change', updateFlow);
      td.appendChild(input);
      dataRow.insertBefore(td, dataRow.lastElementChild);
      
      drawCashflowDiagram();
    }
    
    // 繪製現金流圖
    function drawCashflowDiagram() {
      // 清空 SVG (保留 defs)
      while (svg.lastChild) {
        if (svg.lastChild.tagName === 'defs') break;
        svg.removeChild(svg.lastChild);
      }
      
      const maxTime = times[times.length - 1];
      const viewType = viewTypeSelect.value;
      let maxFlow = Math.max(...flows.map(Math.abs));
      
      // 基準線與網格
      createLine(xStart, baseY, xEnd, baseY, "#333", 1.5, "axisArrow");
      createText("時間 (年)", xEnd + 15, baseY + 5, 14);
      createLine(xStart, 50, xStart, baseY + 150, "#333", 1.5);
      createText("現金流量 ($)", xStart - 10, 35, 14, "#333", "middle");
      
      const stepSize = Math.ceil(maxFlow / 5) * 100;
      for (let i = -3; i <= 3; i++) {
        const yPos = baseY - i * stepSize * scale;
        if (yPos >= 50 && yPos <= baseY + 150) {
          createLine(xStart - 5, yPos, xStart, yPos, "#333", 1);
          createText(i * stepSize, xStart - 10, yPos + 5, 12, "#666", "end");
        }
      }
      
      // 垂直網格與刻度
      times.forEach(t => {
        const xPos = xStart + (t / maxTime) * (xEnd - xStart);
        createLine(xPos, 50, xPos, baseY + 150, "#ddd", 1);
        createText(t, xPos, baseY + 25, 12, "#333", "middle");
      });
      
      // 累計現金流圖
      if (viewType === "cumulative") {
        let cumulativeFlows = [];
        let sum = 0;
        for (let flow of flows) {
          sum += flow;
          cumulativeFlows.push(sum);
        }
        let points = times.map((t, i) => {
          const xPos = xStart + (t / maxTime) * (xEnd - xStart);
          const yPos = baseY - cumulativeFlows[i] * scale;
          return `${xPos},${yPos}`;
        }).join(" ");
        
        const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
        polyline.setAttribute("points", points);
        polyline.setAttribute("fill", "none");
        polyline.setAttribute("stroke", "url(#cumulativeGradient)");
        polyline.setAttribute("stroke-width", 3);
        svg.appendChild(polyline);
        
        times.forEach((t, i) => {
          const xPos = xStart + (t / maxTime) * (xEnd - xStart);
          const yPos = baseY - cumulativeFlows[i] * scale;
          
          const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          circle.setAttribute("cx", xPos);
          circle.setAttribute("cy", yPos);
          circle.setAttribute("r", 5);
          circle.setAttribute("fill", cumulativeFlows[i] >= 0 ? "#27ae60" : "#e74c3c");
          svg.appendChild(circle);
          
          createText(cumulativeFlows[i].toFixed(0), xPos, yPos - 15, 12, cumulativeFlows[i] >= 0 ? "#27ae60" : "#e74c3c", "middle");
        });
      }
      
      // 個別現金流直線
      times.forEach((t, i) => {
        const flow = flows[i];
        const xPos = xStart + (t / maxTime) * (xEnd - xStart);
        
        if (flow !== 0) {
          const lineLen = Math.min(Math.abs(flow) * scale, 120);
          
          if (flow > 0) {
            createLine(xPos, baseY, xPos, baseY - lineLen, "#27ae60", 2);
            const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            circle.setAttribute("cx", xPos);
            circle.setAttribute("cy", baseY - lineLen);
            circle.setAttribute("r", 4);
            circle.setAttribute("fill", "#27ae60");
            svg.appendChild(circle);
            
            const textY = baseY - lineLen - 10;
            createRect(xPos - 25, textY - 15, 50, 20, "white", 0.7);
            createText(flow.toFixed(0), xPos, textY, 12, "#27ae60", "middle", "bold");
          } else {
            createLine(xPos, baseY, xPos, baseY + lineLen, "#e74c3c", 2);
            const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            circle.setAttribute("cx", xPos);
            circle.setAttribute("cy", baseY + lineLen);
            circle.setAttribute("r", 4);
            circle.setAttribute("fill", "#e74c3c");
            svg.appendChild(circle);
            
            const textY = baseY + lineLen + 20;
            createRect(xPos - 25, textY - 15, 50, 20, "white", 0.7);
            createText(Math.abs(flow).toFixed(0), xPos, textY, 12, "#e74c3c", "middle", "bold");
          }
        }
      });
      
      calculatePaybackPeriod();
    }
    
    // 計算淨現值 (NPV)
    function calculateNPV() {
      const rate = parseFloat(interestRateInput.value) / 100;
      let npv = 0;
      
      flows.forEach((flow, i) => {
        npv += flow / Math.pow(1 + rate, i);
      });
      
      npvValue.textContent = `$${npv.toFixed(2)}`;
      npvValue.className = npv >= 0 ? "value-positive" : "value-negative";
    }
    
    // 計算回收期
    function calculatePaybackPeriod() {
      let cumulative = 0;
      let paybackYear = null;
      
      for (let i = 0; i < flows.length; i++) {
        cumulative += flows[i];
        if (cumulative >= 0 && paybackYear === null) {
          paybackYear = i;
        }
      }
      
      paybackPeriod.textContent = (paybackYear !== null) ? paybackYear.toString() : "超過專案期限";
    }
    
    // 建立 SVG 線條元素
    function createLine(x1, y1, x2, y2, color, strokeWidth, markerId) {
      const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      line.setAttribute("x1", x1);
      line.setAttribute("y1", y1);
      line.setAttribute("x2", x2);
      line.setAttribute("y2", y2);
      line.setAttribute("stroke", color);
      line.setAttribute("stroke-width", strokeWidth);
      
      if (markerId) {
        line.setAttribute("marker-end", `url(#${markerId})`);
      }
      
      svg.appendChild(line);
      return line;
    }
    
    // 建立 SVG 文字元素
    function createText(text, x, y, fontSize = 12, color = "black", anchor = "start", fontWeight = "normal") {
      const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
      txt.setAttribute("x", x);
      txt.setAttribute("y", y);
      txt.setAttribute("fill", color);
      txt.setAttribute("font-size", fontSize);
      txt.setAttribute("text-anchor", anchor);
      txt.setAttribute("font-weight", fontWeight);
      txt.textContent = text;
      svg.appendChild(txt);
      return txt;
    }
    
    // 建立 SVG 矩形元素（用作文字背景）
    function createRect(x, y, width, height, fill, opacity = 1) {
      const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
      rect.setAttribute("x", x);
      rect.setAttribute("y", y);
      rect.setAttribute("width", width);
      rect.setAttribute("height", height);
      rect.setAttribute("fill", fill);
      rect.setAttribute("opacity", opacity);
      rect.setAttribute("rx", "3");
      svg.appendChild(rect);
      return rect;
    }
  </script>
</body>
</html>
