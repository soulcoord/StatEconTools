<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>電費計算器（含匯出 Excel）</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">電費計算器（含匯出 Excel）</h1>

    <div class="bg-white p-4 rounded shadow-sm">
      <form id="meterForm" class="grid grid-cols-1 gap-4">
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-sm font-medium">表1 - 上期（數字）</label>
            <input type="number" id="m1_prev" class="mt-1 block w-full rounded border p-2" value="8679">
          </div>
          <div>
            <label class="block text-sm font-medium">表1 - 本期（數字）</label>
            <input type="number" id="m1_curr" class="mt-1 block w-full rounded border p-2" value="8702">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-sm font-medium">表2 - 上期（數字）</label>
            <input type="number" id="m2_prev" class="mt-1 block w-full rounded border p-2" value="8979">
          </div>
          <div>
            <label class="block text-sm font-medium">表2 - 本期（數字）</label>
            <input type="number" id="m2_curr" class="mt-1 block w-full rounded border p-2" value="9049">
          </div>
        </div>

        <div class="grid grid-cols-3 gap-2">
          <div>
            <label class="block text-sm font-medium">單價（元/度）</label>
            <input type="number" id="unit_price" class="mt-1 block w-full rounded border p-2" value="6">
          </div>
          <div>
            <label class="block text-sm font-medium">其他/固定費用（元）</label>
            <input type="number" id="fixed_fee" class="mt-1 block w-full rounded border p-2" value="7350">
          </div>
          <div>
            <label class="block text-sm font-medium">小數位數（顯示）</label>
            <input type="number" id="precision" class="mt-1 block w-full rounded border p-2" value="0">
          </div>
        </div>

        <div class="flex gap-2">
          <button type="button" id="calcBtn" class="px-4 py-2 bg-blue-600 text-white rounded">計算</button>
          <button type="button" id="exportBtn" class="px-4 py-2 bg-green-600 text-white rounded">匯出 Excel</button>
        </div>
      </form>

      <div id="result" class="mt-4 p-3 bg-gray-50 rounded border">
        <div>表1 度數差: <span id="d1">-</span></div>
        <div>表2 度數差: <span id="d2">-</span></div>
        <div>總度數: <span id="total_kwh">-</span></div>
        <div>電費 (總度數×單價): <span id="energy_fee">-</span></div>
        <div>加上其他費用: <span id="total_amount">-</span></div>
      </div>

      <div class="mt-3 text-sm text-gray-600">
        <p>說明：此頁面會計算並顯示度數差、總度數、電費與總金額。匯出的 Excel 檔案會包含原始輸入欄位以及在 Excel 中以公式計算的欄位（若使用者開啟 Excel，會看到公式而非僅數值）。</p>
      </div>
    </div>
  </div>

  <script>
    function toNum(id) { return Number(document.getElementById(id).value || 0); }
    function setText(id, v) { document.getElementById(id).innerText = v; }

    function calculate() {
      const m1_prev = toNum('m1_prev');
      const m1_curr = toNum('m1_curr');
      const m2_prev = toNum('m2_prev');
      const m2_curr = toNum('m2_curr');
      const unit = toNum('unit_price');
      const fee = toNum('fixed_fee');
      const prec = Number(document.getElementById('precision').value);

      const d1 = m1_curr - m1_prev;
      const d2 = m2_curr - m2_prev;
      const total = d1 + d2;
      const energy_fee = total * unit;
      const total_amount = energy_fee + fee;

      setText('d1', d1.toFixed(prec));
      setText('d2', d2.toFixed(prec));
      setText('total_kwh', total.toFixed(prec));
      setText('energy_fee', energy_fee.toFixed(prec));
      setText('total_amount', total_amount.toFixed(prec));

      return { m1_prev, m1_curr, m2_prev, m2_curr, d1, d2, total, unit, energy_fee, fee, total_amount };
    }

    document.getElementById('calcBtn').addEventListener('click', () => {
      calculate();
    });

    document.getElementById('exportBtn').addEventListener('click', () => {
      const data = calculate();

      // 建立要放進 Excel 的 worksheet 資料（包含公式）
      // 我們會在同一個 sheet 中放：標題 | 值或公式 | 說明
      const ws_data = [
        ["欄位", "輸入/公式", "說明"],
        ["表1 - 上期", data.m1_prev, "表1 上期讀數（手動輸入）"],
        ["表1 - 本期", data.m1_curr, "表1 本期讀數（手動輸入）"],
        ["表1 度數差", {f: "=B3-B2"}, "Excel 公式：本期-上期"],
        ["表2 - 上期", data.m2_prev, "表2 上期讀數（手動輸入）"],
        ["表2 - 本期", data.m2_curr, "表2 本期讀數（手動輸入）"],
        ["表2 度數差", {f: "=B6-B5"}, "Excel 公式：本期-上期"],
        ["總度數", {f: "=B4+B7"}, "Excel 公式：兩表度數差相加"],
        ["單價（元/度）", data.unit, "每度價格"],
        ["電費（總度數×單價）", {f: "=B8*B9"}, "Excel 公式：總度數×單價"],
        ["其他/固定費用", data.fee, "其他或固定費用（元）"],
        ["總金額", {f: "=B10+B11"}, "Excel 公式：電費+其他費用"],
      ];

      // 將資料轉成 worksheet
      const ws = XLSX.utils.aoa_to_sheet(ws_data);

      // 調整欄寬（選填）
      ws['!cols'] = [{wpx:160},{wpx:160},{wpx:220}];

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '電費計算');

      // 下載檔名
      const fname = '電費計算.xlsx';
      XLSX.writeFile(wb, fname);
    });

    // 預設計算一次以顯示初始值
    calculate();
  </script>
</body>
</html>
